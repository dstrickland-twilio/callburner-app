# AMD v3 Fixes - November 24, 2024 (FINAL UPDATE)

## Critical Discovery: AsyncAMD vs Regular AMD

### The Core Issue

**AsyncAMD parameters are ONLY valid for REST API-created calls, NOT Client SDK calls!**

CallBurner uses the Twilio Client SDK (`device.connect()`), which generates TwiML-based calls. For these calls:
- ❌ `asyncAmd` is NOT supported on `<Dial>` or `<Number>`
- ❌ `asyncAmdStatusCallback` is NOT supported
- ✅ `machineDetection` IS supported on `<Number>` 
- ✅ `amdStatusCallback` IS supported on `<Number>`

### 1. Error 12200: XML Validation Warning ✅ FIXED

**Problem:** TwiML validation error - "Attribute 'asyncAmdStatusCallback' is not allowed to appear in element 'Number'"

**Root Cause:** Using AsyncAMD parameters (`asyncAmd`, `asyncAmdStatusCallback`) which are only for REST API calls. Client SDK calls must use regular AMD parameters (`machineDetection`, `amdStatusCallback`) on the `<Number>` element.

**Fix Applied:**
```javascript
// BEFORE (INCORRECT - AsyncAMD params):
const numberOptions = {
  machineDetection: 'DetectMessageEnd',
  asyncAmd: 'true',  // ❌ Only for REST API
  asyncAmdStatusCallback: amdCallbackUrl,  // ❌ Only for REST API
  asyncAmdStatusCallbackMethod: 'POST'
};

// AFTER (CORRECT - Regular AMD params):
const numberOptions = {
  machineDetection: 'DetectMessageEnd',
  amdStatusCallback: amdCallbackUrl,  // ✅ Correct for Client SDK
  amdStatusCallbackMethod: 'POST',
  machineDetectionTimeout: 30,
  machineDetectionSpeechThreshold: 2400,
  machineDetectionSpeechEndThreshold: 1500
};
```

**Location:** `/twilio/functions/voice.js`

### 2. Error 21262: Missing AMD Callback URL ✅ FIXED

**Problem:** "No AMD status callback URL was provided. AsyncAmdStatusCallback/AmdStatusCallback parameter: null"

**Root Cause:** Using `asyncAmdStatusCallback` (REST API param) instead of `amdStatusCallback` (Client SDK param).

**Fix:** Same as Error 12200 above - use `amdStatusCallback` instead of `asyncAmdStatusCallback`.

### 3. Error 82005: JSON Parse Error in Hangup Function ✅ FIXED

**Problem:** Function execution error in calls-hangup:
```
Error hanging up call: SyntaxError: Unexpected end of JSON input
```

**Root Cause:** Error handling was trying to parse empty error responses.

**Fix Applied:** Improved error handling with proper JSON formatting.

**Location:** `/twilio/functions/calls-hangup.js`

---

## Expected TwiML Output

After these fixes, the voice.js function generates TwiML like this:

```xml
<Response>
  <Start>
    <Transcription name="Transcription for CAxxxxx" 
                  track="both_tracks" 
                  statusCallbackUrl="https://callburner-functions-2333-dev.twil.io/transcription-realtime" />
  </Start>
  <Dial answerOnBridge="true" 
        recordingStatusCallback="https://callburner-functions-2333-dev.twil.io/calls-status"
        recordingStatusCallbackEvent="in-progress completed"
        recordingStatusCallbackMethod="POST"
        statusCallback="https://callburner-functions-2333-dev.twil.io/calls-status"
        statusCallbackEvent="initiated ringing answered completed"
        callerId="+18557992447"
        record="record-from-answer"
        trim="trim-silence">
    <Number machineDetection="DetectMessageEnd"
            amdStatusCallback="https://callburner-functions-2333-dev.twil.io/calls-amd"
            amdStatusCallbackMethod="POST"
            machineDetectionTimeout="30"
            machineDetectionSpeechThreshold="2400"
            machineDetectionSpeechEndThreshold="1500">
      9187344649
    </Number>
  </Dial>
</Response>
```

**Key Point:** AMD parameters are on `<Number>` element (not `asyncAmd` variants).

---

## Deployment Status

✅ **DEPLOYED** to Twilio Functions at: `callburner-functions-2333-dev.twil.io`

Deployment completed successfully with all fixes applied.

---

## Testing Checklist

After deploying, test with AMD enabled:

### Expected Results:
1. ✅ **No Error 12200** - TwiML validation passes
2. ✅ **No Error 21262** - AMD callback URL properly recognized
3. ✅ **No Error 82005 from hangup** - Proper JSON response
4. ✅ **AMD callback arrives** - `/calls-amd` function receives webhook
5. ✅ **Call status shows AMD data** - Includes `amdResult`, `amdStatus`, etc.

---

## Key Learning: REST API vs Client SDK

### REST API Calls (twilioClient.calls.create)
```javascript
// Use AsyncAMD parameters
{
  machineDetection: 'DetectMessageEnd',
  asyncAmd: true,  // ✅ Valid here
  asyncAmdStatusCallback: 'https://...',  // ✅ Valid here
}
```

### Client SDK Calls (device.connect + TwiML)
```xml
<!-- Use regular AMD parameters on <Number> -->
<Number machineDetection="DetectMessageEnd"
        amdStatusCallback="https://..."
        amdStatusCallbackMethod="POST">
  +15555555555
</Number>
```

**CallBurner uses Client SDK**, so we must use the TwiML approach with regular AMD parameters.

---

## Files Modified

1. `/twilio/functions/voice.js` - Changed from `asyncAmd` to regular AMD params on `<Number>`
2. `/twilio/functions/calls-hangup.js` - Improved error handling

---

## References

- [Twilio AMD Documentation](https://www.twilio.com/docs/voice/answering-machine-detection)
- [TwiML Number Element](https://www.twilio.com/docs/voice/twiml/number#attributes-machine-detection)
- [AMD FAQ & Best Practices](https://www.twilio.com/docs/voice/answering-machine-detection-faq-best-practices)
- [AsyncAMD (REST API only)](https://www.twilio.com/en-us/changelog/async-answering-machine-detection-now-generally-available)

---

## Summary

**Three critical errors fixed by understanding the difference between REST API and Client SDK AMD:**

1. **Error 12200** - Removed invalid `asyncAmd*` attributes from TwiML `<Number>` element
2. **Error 21262** - Now using correct `amdStatusCallback` parameter that Twilio recognizes
3. **Error 82005** - Improved error handling in hangup function

**Status:** ✅ **DEPLOYED AND READY TO TEST**

**Deployment:** `callburner-functions-2333-dev.twil.io`

**Next Step:** Test call with AMD enabled to verify AMD detection results are received.
